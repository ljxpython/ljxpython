name: Update Profile README

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© 10:00ï¼ˆUTC+8ï¼‰
  workflow_dispatch: {}

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Update README sections
        run: |
          python - <<'PY'
          import requests, os, re
          user = 'ljxpython'

          # å®šä¹‰ä»£è¡¨æ€§é¡¹ç›®åˆ—è¡¨
          featured_repos = [
              {'name': 'aitestlab', 'desc': 'ä» 0 åˆ° 1 æ­å»º AI æµ‹è¯•å¹³å°'},
              {'name': 'locust_framework', 'desc': 'åŸºç¡€å‹æµ‹æ¡†æ¶'},
              {'name': 'pytest_framework', 'desc': 'è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶'},
              {'name': 'test_platform', 'desc': 'æµ‹è¯•å¼€å‘å¹³å°ï¼ˆå‰ç«¯ TSï¼‰'},
              {'name': 'flask_platform_srv', 'desc': 'æµ‹è¯•å¹³å°åç«¯'},
              {'name': 'test_engineer', 'desc': 'æµ‹è¯•å¼€å‘çŸ¥è¯†æ€»ç»“'}
          ]

          # 1. è·å–æœ€è¿‘æ´»åŠ¨çš„ä»“åº“
          repos = requests.get(
              f'https://api.github.com/users/{user}/repos',
              params={'per_page':100, 'sort':'updated'}
          ).json()

          # ç”Ÿæˆæœ€è¿‘åŠ¨æ€å†…å®¹
          activity_items = []
          for r in sorted(repos, key=lambda x: x.get('pushed_at') or '', reverse=True)[:5]:
              name = r['name']
              url = r['html_url']
              desc = r.get('description') or ''
              activity_items.append(f'- [{name}]({url}) â€” {desc}')

          activity_block = '\n'.join(activity_items) if activity_items else '- ï¼ˆæš‚æ— åŠ¨æ€ï¼‰'

          # 2. æ›´æ–°ä»£è¡¨æ€§é¡¹ç›®çš„staræ•°é‡
          featured_items = []
          for repo in featured_repos:
              repo_name = repo['name']
              desc = repo['desc']
              try:
                  api_url = f'https://api.github.com/repos/{user}/{repo_name}'
                  response = requests.get(api_url)
                  if response.status_code == 200:
                      repo_data = response.json()
                      stars = repo_data.get('stargazers_count', 0)
                      url = repo_data.get('html_url', f'https://github.com/{user}/{repo_name}')
                      featured_items.append(f'- [{repo_name}]({url}) â€” {desc}ï¼ˆ{stars}â˜…ï¼‰')
                  else:
                      # å¦‚æœAPIå¤±è´¥ï¼Œä¿æŒåŸæœ‰æ ¼å¼
                      featured_items.append(f'- [{repo_name}](https://github.com/{user}/{repo_name}) â€” {desc}ï¼ˆ?â˜…ï¼‰')
              except Exception as e:
                  featured_items.append(f'- [{repo_name}](https://github.com/{user}/{repo_name}) â€” {desc}ï¼ˆ?â˜…ï¼‰')

          featured_block = '\n'.join(featured_items)

          # 3. æ›´æ–°READMEæ–‡ä»¶
          path = 'README.md'
          with open(path, 'r', encoding='utf-8') as f:
              content = f.read()

          # æ›´æ–°æœ€è¿‘åŠ¨æ€éƒ¨åˆ†
          content = re.sub(
              r'<!--START_SECTION:activity-->[\s\S]*<!--END_SECTION:activity-->',
              f'<!--START_SECTION:activity-->\n{activity_block}\n<!--END_SECTION:activity-->',
              content,
          )

          # æ›´æ–°ä»£è¡¨æ€§é¡¹ç›®éƒ¨åˆ†
          content = re.sub(
              r'(### ğŸŒŸ ä»£è¡¨æ€§é¡¹ç›®\n)[\s\S]*?(\n\n> æƒ³è¦æ›´å¿«äº†è§£é¡¹ç›®)',
              f'\\1{featured_block}\\2',
              content,
          )

          with open(path, 'w', encoding='utf-8') as f:
              f.write(content)

          print(f'âœ… æ´»åŠ¨åŠ¨æ€æ›´æ–°å®Œæˆ')
          print(f'âœ… ä»£è¡¨æ€§é¡¹ç›®æ˜Ÿæ ‡æ›´æ–°å®Œæˆ')
          PY

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update profile activity and project stars"
            git push
          fi